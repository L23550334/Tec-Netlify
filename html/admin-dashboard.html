<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Small Dick's Barber</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* --- ESTILOS CORREGIDOS PARA EL ADMIN --- */
        body {
            background-color: #0a0a0a; /* Fondo general oscuro */
        }

        /* Arreglo del Header para que no salgan puntos */
        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
        }
        
        nav ul li a {
            text-decoration: none;
            color: var(--color-primario);
            font-weight: bold;
        }

        /* Layout Principal */
        .admin-layout {
            display: flex;
            min-height: calc(100vh - 80px); /* Restamos la altura del header */
        }
        
        /* Men√∫ Lateral */
        .sidebar {
            width: 250px;
            background-color: #151515;
            border-right: 1px solid #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .sidebar button {
            background: none;
            border: 1px solid #333;
            color: #ccc;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.3s;
            font-size: 1rem;
            width: 100%;
        }
        
        .sidebar button:hover, .sidebar button.active {
            background-color: var(--color-primario);
            color: #0a0a0a;
            font-weight: bold;
            border-color: var(--color-primario);
        }

        /* Contenido Principal */
        .admin-content {
            flex: 1;
            padding: 2rem;
            background-color: #0a0a0a; /* Fondo negro para el contenido */
            color: white;
        }

        h2 { color: var(--color-primario); margin-bottom: 0.5rem; }
        .subtitulo-catalogo { color: #888; margin-bottom: 2rem; }

        /* TABLA MEJORADA */
        .table-container {
            overflow-x: auto;
            background-color: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            color: #eee;
        }
        
        thead {
            background-color: #252525;
            border-bottom: 2px solid var(--color-primario);
        }

        th {
            padding: 15px;
            text-align: left;
            color: var(--color-primario);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #333;
        }
        
        tr:hover {
            background-color: #222;
        }

        /* Botones de Acci√≥n */
        .btn-accion {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .btn-editar { background-color: #ffc107; color: black; }
        .btn-borrar { background-color: #ff4d4d; color: white; }

        .section-panel { display: none; }
        .section-panel.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Added styles for search boxes and forms */
        .search-box {
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .search-box label {
            display: block;
            color: var(--color-primario);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .search-box select,
        .search-box input {
            width: 100%;
            padding: 10px;
            background-color: #0a0a0a;
            border: 1px solid #333;
            color: white;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .search-box button {
            padding: 10px 20px;
            background-color: var(--color-primario);
            color: #0a0a0a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }

        .search-box button:hover {
            opacity: 0.9;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .error-message {
            color: #ff4d4d;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }
        /* </CHANGE> */
    </style>
</head>
<body>

    <header>
        <nav>
            <a href="../index.html" class="logo">Small Dick's Barber</a>
            <div class="nav-links-group">
                <ul>
                    <li><a href="../index.html">üè† Volver al Inicio</a></li>
                    <li><a href="#" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="admin-layout">
        
        <aside class="sidebar">
            <button onclick="mostrarSeccion('productos')" class="active">üì¶ Productos</button>
            <button onclick="mostrarSeccion('citas')">üìÖ Citas</button>
            <button onclick="mostrarSeccion('usuarios')">üë• Usuarios</button>
        </aside>

        <section class="admin-content">

            <!-- PRODUCTOS Panel with primary key search and dynamic table -->
            <div id="panel-productos" class="section-panel active">
                <h2>Gesti√≥n de Inventario</h2>
                <p class="subtitulo-catalogo">Control de productos en venta.</p>
                
                <!-- Primary Key Search: Search by Product ID -->
                <div class="search-box">
                    <h3>üîç B√∫squeda por Llave Primaria (ID Producto)</h3>
                    <label for="buscar-producto-id">Selecciona un Producto:</label>
                    <select id="buscar-producto-id">
                        <option value="">-- Cargar productos --</option>
                    </select>
                    <button onclick="buscarProductoPorId()">Buscar</button>
                    <button onclick="editarProducto()">Editar</button>
                    <button onclick="eliminarProducto()">Eliminar</button>
                </div>

                <button class="btn-cita" style="margin-bottom: 20px;" onclick="mostrarFormularioNuevoProducto()">+ Nuevo Producto</button>
                
                <!-- Dynamic Table 1: Products Grid -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos-body">
                            <tr><td colspan="5" style="text-align:center; padding: 20px;">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CITAS Panel with foreign key searches and dynamic tables -->
            <div id="panel-citas" class="section-panel">
                <h2>Citas Programadas</h2>
                <p class="subtitulo-catalogo">Agenda de la barber√≠a.</p>
                
                <!-- Primary Key Search: Search by Appointment ID -->
                <div class="search-box">
                    <h3>üîç B√∫squeda por Llave Primaria (ID Cita)</h3>
                    <label for="buscar-cita-id">Selecciona una Cita:</label>
                    <select id="buscar-cita-id">
                        <option value="">-- Cargar citas --</option>
                    </select>
                    <button onclick="buscarCitaPorId()">Buscar</button>
                    <button onclick="actualizarCita()">Actualizar</button>
                    <button onclick="eliminarCita()">Eliminar</button>
                </div>

                <!-- Foreign Key Search 1: Search by Barber (id_barbero) -->
                <div class="search-box">
                    <h3>üîç B√∫squeda por Llave For√°nea (Barbero)</h3>
                    <label for="buscar-barbero">Selecciona un Barbero:</label>
                    <select id="buscar-barbero">
                        <option value="">-- Seleccionar barbero --</option>
                    </select>
                    <button onclick="buscarCitasPorBarbero()">Mostrar Citas</button>
                </div>

                <!-- Foreign Key Search 2: Search by Client (id_cliente) -->
                <div class="search-box">
                    <h3>üîç B√∫squeda por Llave For√°nea (Cliente)</h3>
                    <label for="buscar-cliente">Selecciona un Cliente:</label>
                    <select id="buscar-cliente">
                        <option value="">-- Seleccionar cliente --</option>
                    </select>
                    <button onclick="buscarCitasPorCliente()">Mostrar Citas</button>
                </div>

                <!-- Dynamic Table 2: Appointments Grid -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Barbero</th>
                                <th>Fecha</th>
                                <th>Servicio</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-citas-body">
                            <tr><td colspan="6" style="text-align:center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- USUARIOS Panel with primary key search and foreign key search -->
            <div id="panel-usuarios" class="section-panel">
                <h2>Usuarios Registrados</h2>
                <p class="subtitulo-catalogo">Clientes y personal.</p>

                <!-- Primary Key Search: Search by User ID -->
                <div class="search-box">
                    <h3>üîç B√∫squeda por Llave Primaria (ID Usuario)</h3>
                    <label for="buscar-usuario-id">Selecciona un Usuario:</label>
                    <select id="buscar-usuario-id">
                        <option value="">-- Cargar usuarios --</option>
                    </select>
                    <button onclick="buscarUsuarioPorId()">Buscar</button>
                    <button onclick="actualizarUsuario()">Actualizar</button>
                    <button onclick="eliminarUsuario()">Eliminar</button>
                </div>

                <!-- Foreign Key Search 3: Search by Role (rol) -->
                <div class="search-box">
                    <h3>üîç B√∫squeda por Llave For√°nea (Rol)</h3>
                    <label for="buscar-rol">Selecciona un Rol:</label>
                    <select id="buscar-rol">
                        <option value="">-- Todos los roles --</option>
                        <option value="1">Admin</option>
                        <option value="2">Barbero</option>
                        <option value="3">Cliente</option>
                    </select>
                    <button onclick="buscarUsuariosPorRol()">Mostrar Usuarios</button>
                </div>

                <!-- Dynamic Table 3: Users Grid -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Tel√©fono</th>
                                <th>Rol</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-usuarios-body">
                            <tr><td colspan="5" style="text-align:center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </section>
    </main>

    <script src="../JS/admin-dashboard.js"></script>
    <script>
        let productosData = [];
        let citasData = [];
        let usuariosData = [];
        let barberosData = [];
        let clientesData = [];
        
        console.log('[v0] Dashboard de Admin iniciado');

        function mostrarSeccion(id) {
            document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            document.getElementById('panel-' + id).classList.add('active');
            event.target.classList.add('active');

            if (id === 'productos') {
                cargarProductos();
            } else if (id === 'citas') {
                cargarCitas();
                cargarBarberos();
                cargarClientes();
            } else if (id === 'usuarios') {
                cargarUsuarios();
            }
        }

        function validarPrecio(precio) {
            if (isNaN(precio) || precio <= 0) {
                alert('‚ùå VALIDACI√ìN: El precio debe ser un n√∫mero positivo mayor a 0');
                return false;
            }
            return true;
        }

        function validarStock(stock) {
            if (!Number.isInteger(Number(stock)) || stock < 0) {
                alert('‚ùå VALIDACI√ìN: El stock debe ser un n√∫mero entero no negativo');
                return false;
            }
            return true;
        }

        function cargarProductos() {
            console.log('[v0] Cargando productos...');
            fetch('../php/productos_get.php')
                .then(res => {
                    console.log('[v0] Respuesta recibida de productos_get.php');
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Productos recibidos:', data);
                    productosData = data;
                    const tbody = document.getElementById('tabla-productos-body');
                    const select = document.getElementById('buscar-producto-id');
                    
                    tbody.innerHTML = ''; 
                    select.innerHTML = '<option value="">-- Seleccionar producto --</option>';

                    if(data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay productos registrados</td></tr>';
                        return;
                    }

                    data.forEach(prod => {
                        select.innerHTML += `<option value="${prod.id_producto}">#${prod.id_producto} - ${prod.nombre}</option>`;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>#${prod.id_producto}</td>
                                <td>${prod.nombre}</td>
                                <td>$${prod.precio}</td>
                                <td>${prod.stock} un.</td>
                                <td>
                                    <button class="btn-accion btn-editar" onclick="editarProductoDirecto(${prod.id_producto})">Editar</button>
                                    <button class="btn-accion btn-borrar" onclick="eliminarProductoDirecto(${prod.id_producto})">Borrar</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('[v0] Error al cargar productos:', err);
                    document.getElementById('tabla-productos-body').innerHTML = 
                        '<tr><td colspan="5" style="text-align:center; color:red;">Error al cargar datos: ' + err.message + '</td></tr>';
                });
        }

        function buscarProductoPorId() {
            const id = document.getElementById('buscar-producto-id').value;
            if (!id) {
                alert('Por favor selecciona un producto');
                return;
            }
            const producto = productosData.find(p => p.id_producto == id);
            if (producto) {
                alert(`üì¶ PRODUCTO ENCONTRADO:\n\nID: ${producto.id_producto}\nNombre: ${producto.nombre}\nPrecio: $${producto.precio}\nStock: ${producto.stock}`);
            }
        }

        function editarProductoDirecto(id) {
            const producto = productosData.find(p => p.id_producto == id);
            if (!producto) {
                alert('Producto no encontrado');
                return;
            }
            
            const nuevoNombre = prompt('Nuevo nombre:', producto.nombre);
            if (!nuevoNombre) return;
            
            const nuevoPrecio = prompt('Nuevo precio:', producto.precio);
            if (!nuevoPrecio || !validarPrecio(nuevoPrecio)) return;
            
            const nuevoStock = prompt('Nuevo stock:', producto.stock);
            if (!nuevoStock || !validarStock(nuevoStock)) return;
            
            const nuevaDescripcion = prompt('Nueva descripci√≥n:', producto.descripcion || '');
            
            console.log('[v0] Actualizando producto:', id);
            fetch('../php/productos_actualizar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_producto: id,
                    nombre: nuevoNombre,
                    precio: parseFloat(nuevoPrecio),
                    stock: parseInt(nuevoStock),
                    descripcion: nuevaDescripcion
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Producto actualizado correctamente');
                    cargarProductos();
                } else {
                    alert('Error: ' + data.mensaje);
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi√≥n');
            });
        }

        function eliminarProductoDirecto(id) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;
            
            console.log('[v0] Eliminando producto:', id);
            fetch('../php/productos_eliminar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_producto: id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Producto eliminado correctamente');
                    cargarProductos();
                } else {
                    alert('Error: ' + data.mensaje);
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi√≥n');
            });
        }

        function editarProducto() {
            const id = document.getElementById('buscar-producto-id').value;
            if (!id) {
                alert('Por favor selecciona un producto para editar');
                return;
            }
            const producto = productosData.find(p => p.id_producto == id);
            if (producto) {
                const nuevoNombre = prompt('Nuevo nombre:', producto.nombre);
                const nuevoPrecio = prompt('Nuevo precio:', producto.precio);
                const nuevoStock = prompt('Nuevo stock:', producto.stock);
                
                if (nuevoNombre && nuevoPrecio && nuevoStock) {
                    if (!validarPrecio(nuevoPrecio)) return;
                    if (!validarStock(nuevoStock)) return;
                    alert('‚úÖ Producto actualizado (simulado)');
                }
            }
        }

        function mostrarFormularioNuevoProducto() {
            const nombre = prompt('Nombre del producto:');
            if (!nombre) return;
            
            const precio = prompt('Precio:');
            if (!precio || !validarPrecio(precio)) return;
            
            const stock = prompt('Stock inicial:');
            if (!stock || !validarStock(stock)) return;
            
            const descripcion = prompt('Descripci√≥n (opcional):') || '';
            
            console.log('[v0] Creando producto nuevo');
            fetch('../php/productos_crear.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre: nombre,
                    precio: parseFloat(precio),
                    stock: parseInt(stock),
                    descripcion: descripcion
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Producto creado correctamente');
                    cargarProductos();
                } else {
                    alert('Error: ' + data.mensaje);
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi√≥n');
            });
        }

        function cargarCitas() {
            console.log('[v0] Cargando citas...');
            fetch('../php/citas_admin_get.php')
                .then(res => {
                    console.log('[v0] Respuesta recibida de citas_admin_get.php');
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Citas recibidas:', data);
                    citasData = data;
                    const tbody = document.getElementById('tabla-citas-body');
                    const select = document.getElementById('buscar-cita-id');
                    
                    tbody.innerHTML = '';
                    select.innerHTML = '<option value="">-- Seleccionar cita --</option>';

                    if(data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay citas registradas</td></tr>';
                        return;
                    }

                    data.forEach(cita => {
                        const fechaObj = new Date(cita.fecha_hora);
                        const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        select.innerHTML += `<option value="${cita.id_cita}">#${cita.id_cita} - ${cita.cliente_nombre} - ${fechaStr}</option>`;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>#${cita.id_cita}</td>
                                <td>${cita.cliente_nombre}</td>
                                <td>${cita.barbero_nombre}</td>
                                <td>${fechaStr}</td>
                                <td>${cita.servicio}</td>
                                <td>
                                    <span class="estado-badge ${cita.estado}">${cita.estado}</span>
                                    <button class="btn-accion btn-editar" onclick="actualizarEstado(${cita.id_cita}, 'completada')">Completar</button>
                                    <button class="btn-accion btn-borrar" onclick="actualizarEstado(${cita.id_cita}, 'cancelada')">Cancelar</button>
                                    <button class="btn-accion btn-borrar" onclick="eliminarCitaDirecto(${cita.id_cita})">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('[v0] Error al cargar citas:', err);
                    document.getElementById('tabla-citas-body').innerHTML = 
                        '<tr><td colspan="6" style="text-align:center; color:red;">Error al cargar datos: ' + err.message + '</td></tr>';
                });
        }

        function buscarCitaPorId() {
            const id = document.getElementById('buscar-cita-id').value;
            if (!id) {
                alert('Por favor selecciona una cita');
                return;
            }
            const cita = citasData.find(c => c.id_cita == id);
            if (cita) {
                const fechaObj = new Date(cita.fecha_hora);
                const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString();
                alert(`üìÖ CITA ENCONTRADA:\n\nID: ${cita.id_cita}\nCliente: ${cita.cliente_nombre}\nBarbero: ${cita.barbero_nombre}\nServicio: ${cita.servicio}\nFecha: ${fechaStr}\nEstado: ${cita.estado}`);
            }
        }

        function actualizarCita() {
            const id = document.getElementById('buscar-cita-id').value;
            if (!id) {
                alert('Por favor selecciona una cita');
                return;
            }
            const nuevoEstado = prompt('Nuevo estado (pendiente/completada/cancelada):');
            if (nuevoEstado) {
                actualizarEstado(id, nuevoEstado);
            }
        }

        function eliminarCita() {
            const id = document.getElementById('buscar-cita-id').value;
            if (!id) {
                alert('Por favor selecciona una cita para eliminar');
                return;
            }
            eliminarCitaDirecto(id);
        }

        function buscarCitasPorBarbero() {
            const barberoId = document.getElementById('buscar-barbero').value;
            if (!barberoId) {
                alert('Por favor selecciona un barbero');
                return;
            }
            
            const tbody = document.getElementById('tabla-citas-body');
            tbody.innerHTML = '';
            
            const citasFiltradas = citasData.filter(c => c.id_barbero == barberoId);
            
            if (citasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay citas para este barbero</td></tr>';
                return;
            }

            citasFiltradas.forEach(cita => {
                const fechaObj = new Date(cita.fecha_hora);
                const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                tbody.innerHTML += `
                    <tr>
                        <td>#${cita.id_cita}</td>
                        <td>${cita.cliente_nombre}</td>
                        <td>${cita.barbero_nombre}</td>
                        <td>${fechaStr}</td>
                        <td>${cita.servicio}</td>
                        <td>
                            <span class="estado-badge ${cita.estado}">${cita.estado}</span>
                            <button class="btn-accion btn-editar" onclick="actualizarEstado(${cita.id_cita}, 'completada')">‚úÖ</button>
                            <button class="btn-accion btn-borrar" onclick="actualizarEstado(${cita.id_cita}, 'cancelada')">‚ùå</button>
                        </td>
                    </tr>
                `;
            });
        }

        function buscarCitasPorCliente() {
            const clienteId = document.getElementById('buscar-cliente').value;
            if (!clienteId) {
                alert('Por favor selecciona un cliente');
                return;
            }
            
            alert('Filtrar por cliente ID: ' + clienteId + ' (funci√≥n a implementar)');
        }

        function cargarBarberos() {
            console.log('[v0] Cargando barberos...');
            fetch('../php/barberos_get_admin.php')
                .then(res => {
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Barberos recibidos:', data);
                    barberosData = data;
                    const select = document.getElementById('buscar-barbero');
                    select.innerHTML = '<option value="">-- Seleccionar barbero --</option>';
                    
                    data.forEach(barbero => {
                        select.innerHTML += `<option value="${barbero.id_usuario}">${barbero.nombre}</option>`;
                    });
                })
                .catch(err => console.error('[v0] Error al cargar barberos:', err));
        }

        function cargarClientes() {
            console.log('[v0] Cargando clientes...');
            fetch('../php/clientes_get_admin.php')
                .then(res => {
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Clientes recibidos:', data);
                    clientesData = data;
                    const select = document.getElementById('buscar-cliente');
                    select.innerHTML = '<option value="">-- Seleccionar cliente --</option>';
                    
                    data.forEach(cliente => {
                        select.innerHTML += `<option value="${cliente.id_usuario}">${cliente.nombre}</option>`;
                    });
                })
                .catch(err => console.error('[v0] Error al cargar clientes:', err));
        }

        function cargarUsuarios() {
            console.log('[v0] Cargando usuarios...');
            fetch('../php/usuarios_get.php')
                .then(res => {
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Usuarios recibidos:', data);
                    usuariosData = data;
                    const tbody = document.getElementById('tabla-usuarios-body');
                    const select = document.getElementById('buscar-usuario-id');
                    
                    tbody.innerHTML = '';
                    select.innerHTML = '<option value="">-- Seleccionar usuario --</option>';

                    if(data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay usuarios registrados</td></tr>';
                        return;
                    }

                    data.forEach(usuario => {
                        select.innerHTML += `<option value="${usuario.id_usuario}">#${usuario.id_usuario} - ${usuario.nombre}</option>`;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>#${usuario.id_usuario}</td>
                                <td>${usuario.nombre}</td>
                                <td>${usuario.email}</td>
                                <td>${usuario.telefono || 'N/A'}</td>
                                <td>${usuario.rol_texto}</td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('[v0] Error al cargar usuarios:', err);
                    document.getElementById('tabla-usuarios-body').innerHTML = 
                        '<tr><td colspan="5" style="text-align:center; color:red;">Error al cargar datos: ' + err.message + '</td></tr>';
                });
        }

        function buscarUsuarioPorId() {
            const id = document.getElementById('buscar-usuario-id').value;
            if (!id) {
                alert('Por favor selecciona un usuario');
                return;
            }
            const usuario = usuariosData.find(u => u.id_usuario == id);
            if (usuario) {
                alert(`üë§ USUARIO ENCONTRADO:\n\nID: ${usuario.id_usuario}\nNombre: ${usuario.nombre}\nEmail: ${usuario.email}\nTel√©fono: ${usuario.telefono || 'N/A'}\nRol: ${usuario.rol_texto}`);
            }
        }

        function actualizarUsuario() {
            alert('Funci√≥n de actualizar usuario a implementar');
        }

        function eliminarUsuario() {
            alert('Funci√≥n de eliminar usuario a implementar');
        }

        function buscarUsuariosPorRol() {
            const rol = document.getElementById('buscar-rol').value;
            if (!rol) {
                cargarUsuarios();
                return;
            }
            
            const tbody = document.getElementById('tabla-usuarios-body');
            tbody.innerHTML = '';
            
            const usuariosFiltrados = usuariosData.filter(u => u.rol == rol);
            
            if (usuariosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay usuarios con este rol</td></tr>';
                return;
            }

            usuariosFiltrados.forEach(usuario => {
                tbody.innerHTML += `
                    <tr>
                        <td>#${usuario.id_usuario}</td>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.email}</td>
                        <td>${usuario.telefono || 'N/A'}</td>
                        <td>${usuario.rol_texto}</td>
                    </tr>
                `;
            });
        }

        function actualizarEstado(id, estado) {
            if (!confirm(`¬øConfirmar cambio de estado a "${estado}"?`)) return;
            
            console.log('[v0] Actualizando estado de cita:', id, estado);
            fetch('../php/citas_actualizar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_cita: id, estado: estado })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Estado actualizado correctamente');
                    cargarCitas();
                } else {
                    alert('Error: ' + data.mensaje);
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi√≥n');
            });
        }

        function eliminarCitaDirecto(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta cita?')) return;
            
            console.log('[v0] Eliminando cita:', id);
            fetch('../php/citas_eliminar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_cita: id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Cita eliminada correctamente');
                    cargarCitas();
                } else {
                    alert('Error: ' + data.mensaje);
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi√≥n');
            });
        }

        document.addEventListener('DOMContentLoaded', cargarProductos);

        function cerrarSesion() {
            if(confirm("¬øCerrar sesi√≥n?")) window.location.href = '../index.html';
        }
    </script>
</body>
</html>

