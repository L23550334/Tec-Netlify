<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - La Quinta Esencia Barber Shop </title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="../JS/auth-guard.js"></script>
    <style>
        /* --- Estilos para el admin --- */
        body {
            background-color: #0a0a0a; /* Fondo general oscuro */
        }

        /* Arreglo del Header para que no salgan puntos */
        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
            flex-wrap: wrap;
        }
        
        nav ul li a {
            text-decoration: none;
            color: var(--color-primario);
            font-weight: bold;
        }

        /* Layout Principal */
        .admin-layout {
            display: flex;
            flex-direction: row;
            min-height: calc(100vh - 80px); /* Restamos la altura del header */
        }
        
        /* Men煤 Lateral */
        .sidebar {
            width: 250px;
            background-color: #151515;
            border-right: 1px solid #333;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .sidebar button {
            background: none;
            border: 1px solid #333;
            color: #ccc;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.3s;
            font-size: 1rem;
            width: 100%;
        }
        
        .sidebar button:hover, .sidebar button.active {
            background-color: var(--color-primario);
            color: #0a0a0a;
            font-weight: bold;
            border-color: var(--color-primario);
        }

        /* Contenido Principal */
        .admin-content {
            flex: 1;
            padding: 2rem;
            background-color: #0a0a0a; /* Fondo negro para el contenido */
            color: white;
            overflow-y: auto;
        }

        h2 { color: var(--color-primario); margin-bottom: 0.5rem; }
        .subtitulo-catalogo { color: #888; margin-bottom: 2rem; }

        /* Tabla */
        .table-container {
            overflow-x: auto;
            background-color: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            color: #eee;
        }
        
        thead {
            background-color: #252525;
            border-bottom: 2px solid var(--color-primario);
        }

        th {
            padding: 15px;
            text-align: left;
            color: var(--color-primario);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #333;
        }
        
        tr:hover {
            background-color: #222;
        }

        /* Botones de Acci贸n */
        .btn-accion {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .btn-editar { background-color: #ffc107; color: black; }
        .btn-borrar { background-color: #ff4d4d; color: white; }
        .btn-eliminar { background-color: #ff4d4d; color: white; } 

        .section-panel { display: none; }
        .section-panel.active { display: block; animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos para buscar cajas y formas*/
        .search-box {
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .search-box label {
            display: block;
            color: var(--color-primario);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .search-box select,
        .search-box input {
            width: 100%;
            padding: 10px;
            background-color: #0a0a0a;
            border: 1px solid #333;
            color: white;
            border-radius: 4px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .search-box button {
            padding: 10px 20px;
            background-color: var(--color-primario);
            color: #0a0a0a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .search-box button:hover {
            opacity: 0.9;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .error-message {
            color: #ff4d4d;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .btn-cita {
            padding: 12px 24px;
            background-color: var(--color-primario);
            color: #0a0a0a;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
        }

        .btn-cita:hover {
            opacity: 0.9;
        }

        
        @media (max-width: 768px) {
            .admin-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #333;
                flex-direction: row;
                gap: 10px;
                overflow-x: auto;
                padding: 10px;
            }

            .sidebar button {
                padding: 10px 15px;
                font-size: 0.9rem;
                white-space: nowrap;
                min-width: fit-content;
            }

            .admin-content {
                padding: 1rem;
                min-height: auto;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px;
            }

            .btn-accion {
                padding: 4px 8px;
                font-size: 0.7rem;
                margin-right: 2px;
            }

            .search-box {
                padding: 15px;
                margin-bottom: 15px;
            }

            h2 {
                font-size: 1.3rem;
            }

            .btn-cita {
                width: 100%;
                padding: 10px;
            }

            .search-box button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 8px;
            }
        }

        @media (max-width: 480px) {
            nav ul {
                gap: 10px;
                font-size: 0.85rem;
            }

            .admin-content {
                padding: 0.5rem;
            }

            table {
                font-size: 0.75rem;
            }

            th, td {
                padding: 8px;
            }

            .btn-accion {
                padding: 3px 6px;
                font-size: 0.65rem;
            }

            h2 {
                font-size: 1.1rem;
            }

            .search-box h3 {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }

            .search-box label {
                font-size: 0.85rem;
            }

            .subtitulo-catalogo {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>

    <header>
        <nav>
            <a href="../index.html" class="logo">La Quinta Esencia Barber Shop </a>
            <div class="nav-links-group">
                <ul>
                    <li><a href="../index.html">Volver al Inicio</a></li>
            </ul>
            </div>
        </nav>
    </header>

    <main class="admin-layout">
        
        <aside class="sidebar">
            <button onclick="mostrarSeccion('productos')" class="active"> Productos</button>
            <button onclick="mostrarSeccion('citas')"> Citas</button>
            <button onclick="mostrarSeccion('usuarios')"> Usuarios</button>
            <button onclick="mostrarSeccion('reportes')"> Reportes</button>
        </aside>

        <section class="admin-content">

            <!-- Panel con llave primaria -->
            <div id="panel-productos" class="section-panel active">
                <h2 style="color:black">Gesti贸n de Inventario</h2>
                <h4 style="color:black">Control de productos en venta.</h4>
                
                <!-- Busqueda con ID producto -->
                <div class="search-box">
                    <h3>B煤squeda por Producto</h3>
                    <label for="buscar-producto-id">Selecciona un Producto:</label>
                    <select id="buscar-producto-id">
                        <option value="">-- Cargar productos --</option>
                    </select>
                    <button onclick="buscarProductoPorId()">Buscar</button>
                    <button onclick="editarProducto()">Editar</button>
                    <button onclick="eliminarProducto()">Eliminar</button>
                </div>

                <button class="btn-cita" style="margin-bottom: 20px;" onclick="mostrarFormularioNuevoProducto()">+ Nuevo Producto</button>
                
                <!-- Tabla dinamica 1: Productos GRID -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos-body">
                            <tr><td colspan="5" style="text-align:center; padding: 20px;">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="panel-citas" class="section-panel">
                <h2 style="color:black">Citas Programadas</h2>
                <h4 style="color:black">Agenda de la barber铆a.</h4>
                
                <!-- Removidas b煤squedas por ID, Barbero y Cliente. Manteniendo solo b煤squeda por Estado -->
                <div class="search-box">
                    <h3>B煤squeda por Estado de Cita</h3>
                    <label for="buscar-estado">Selecciona un Estado:</label>
                    <select id="buscar-estado">
                        <option value="">-- Todos los estados --</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="completada">Completada</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                    <button onclick="buscarCitasPorEstado()">Mostrar Citas</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Barbero</th>
                                <th>Fecha</th>
                                <th>Servicio</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-citas-body">
                            <tr><td colspan="7" style="text-align:center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="panel-usuarios" class="section-panel">
                <h2 style="color:black">Gesti贸n de Usuarios</h2>
                <h4 style="color:black">Clientes y personal.</h4>

                <div class="search-box">
                    <h3>Filtrar por Rol</h3>
                    <label for="buscar-rol">Selecciona un Rol:</label>
                    <select id="buscar-rol">
                        <option value="">-- Todos los roles --</option>
                        <option value="1">Admin</option>
                        <option value="2">Barbero</option>
                        <option value="3">Cliente</option>
                    </select>
                    <button onclick="buscarUsuariosPorRol()">Filtrar</button>
                    <button onclick="cargarUsuarios()">Mostrar Todos</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Tel茅fono</th>
                                <th>Rol</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-usuarios-body">
                            <tr><td colspan="6" style="text-align:center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="panel-reportes" class="section-panel">
                <h2 style="color:black">Reportes de Gerencia</h2>
                <p style="color:black">An谩lisis de rendimiento del negocio.</p>
                
                <div class="search-box" style="margin-bottom: 20px;">
                    <button onclick="mostrarReporte('ingresos')" id="btn-reporte-ingresos" style="margin-right: 10px; padding: 10px 20px; background: #00d4ff; border: none; border-radius: 5px; cursor: pointer; color: #000; font-weight: bold;">Ingresos por Servicio</button>
                    <button onclick="mostrarReporte('estadisticas')" id="btn-reporte-estadisticas" style="padding: 10px 20px; background: #333; border: 1px solid #555; border-radius: 5px; cursor: pointer; color: #fff;">Estad铆sticas de Citas</button>
                </div>

                <!-- Reporte de Ingresos -->
                <div id="reporte-ingresos" style="display: block;">
                    <div class="search-box">
                        <h3>Reporte de Ingresos por Servicio</h3>
                        <p style="color: #ccc; font-size: 0.9rem;">Muestra los ingresos generados por cada tipo de servicio con estado "completada".</p>
                         </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th>Citas Realizadas</th>
                                    <th>Ingresos Generados</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-reporte-ingresos-body">
                                <tr><td colspan="3" style="text-align:center; padding: 20px;">Cargando reporte...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <button onclick="descargarReporteIngresos()" style="margin-top: 15px; padding: 10px 20px; background-color: #163317; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Descargar Tabla (CSV)</button>
                   
                </div>

                <!-- Reporte de Estad铆sticas -->
                <div id="reporte-estadisticas" style="display: none;">
                    <div class="search-box">
                        <h3>Estad铆sticas Generales de Citas</h3>
                        <p style="color: #ccc; font-size: 0.9rem;">Resumen completo del desempe帽o de citas y barberos.</p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #131313 100%); padding: 20px; border-radius: 10px;">
                            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9; ">Total de Citas</p>
                            <h2 id="stat-total" style="margin: 10px 0 0 0; font-size: 2rem;">-</h2>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #000000 100%); padding: 20px; border-radius: 10px;">
                            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Completadas</p>
                            <h2 id="stat-completadas" style="margin: 10px 0 0 0; font-size: 2rem;">-</h2>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #000000 100%); padding: 20px; border-radius: 10px;">
                            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Pendientes</p>
                            <h2 id="stat-pendientes" style="margin: 10px 0 0 0; font-size: 2rem;">-</h2>
                        </div>
                        <div style="background: linear-gradient(135deg, #fa709a 0%, #000000 100%); padding: 20px; border-radius: 10px;">
                            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Canceladas</p>
                            <h2 id="stat-canceladas" style="margin: 10px 0 0 0; font-size: 2rem;">-</h2>
                        </div>
                    </div>

                    <!-- Citas por Estado -->
                    <div class="search-box">
                        <h4>Distribuci贸n por Estado</h4>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Estado</th>
                                    <th>Cantidad</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-estado-body">
                                <tr><td colspan="3" style="text-align:center; padding: 20px;">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Citas por Barbero -->
                    <div class="search-box" style="margin-top: 25px;">
                        <h4>Desempe帽o por Barbero</h4>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Barbero</th>
                                    <th>Total Citas</th>
                                    <th>Completadas</th>
                                    <th>Tasa de xito</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-barbero-body">
                                <tr><td colspan="4" style="text-align:center; padding: 20px;">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Citas por Mes -->
                    <div class="search-box" style="margin-top: 25px;">
                        <h4>Tendencia Mensual (ltimos 6 meses)</h4>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Mes</th>
                                    <th>Total Citas</th>
                                    <th>Completadas</th>
                                    <th>Tasa de Finalizaci贸n</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-mes-body">
                                <tr><td colspan="4" style="text-align:center; padding: 20px;">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Verificar acceso antes de cargar cualquier cosa
        if (!verificarAcceso('admin')) {
            // La funci贸n verificarAcceso ya redirige si no hay acceso
            throw new Error('Acceso denegado');
        }
        
        let productosData = [];
        let citasData = [];
        let usuariosData = [];
        let barberosData = [];
        let clientesData = [];
        
        console.log('[v0] Dashboard de Admin iniciado');

        function mostrarSeccion(id) {
            console.log('[v0] Mostrando secci贸n:', id);
            document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            document.getElementById('panel-' + id).classList.add('active');
            event.target.classList.add('active');

            if (id === 'productos') {
                cargarProductos();
            } else if (id === 'citas') {
                cargarCitas();
                cargarBarberos();
                cargarClientes();
            } else if (id === 'usuarios') {
                cargarUsuarios();
            } else if (id === 'reportes') {
                mostrarReporte('ingresos');
            }
        }

        function validarPrecio(precio) {
            const precioNum = parseFloat(precio);
            if (isNaN(precioNum) || precioNum <= 0) {
                alert('VALIDACIN: El precio debe ser un n煤mero positivo mayor a 0');
                return false;
            }
            return true;
        }

        function validarStock(stock) {
            const stockNum = parseInt(stock);
            if (isNaN(stockNum) || stockNum < 0 || !Number.isInteger(parseFloat(stock))) {
                alert('VALIDACIN: El stock debe ser un n煤mero entero no negativo');
                return false;
            }
            return true;
        }

        function cargarProductos() {
            console.log('[v0] Cargando productos desde productos_get.php...');
            fetch('../php/productos_get.php')
                .then(res => {
                    console.log('[v0] Respuesta recibida de productos_get.php, status:', res.status);
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Productos recibidos:', data);
                    productosData = data;
                    const tbody = document.getElementById('tabla-productos-body');
                    const select = document.getElementById('buscar-producto-id');
                    
                    tbody.innerHTML = ''; 
                    select.innerHTML = '<option value="">-- Seleccionar producto --</option>';

                    if(!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay productos registrados</td></tr>';
                        return;
                    }

                    data.forEach(prod => {
                        select.innerHTML += `<option value="${prod.id_producto}">#${prod.id_producto} - ${prod.nombre}</option>`;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>#${prod.id_producto}</td>
                                <td>${prod.nombre}</td>
                                <td>$${prod.precio}</td>
                                <td>${prod.stock} un.</td>
                                <td>
                                    <button class="btn-accion btn-editar" onclick="editarProductoDirecto(${prod.id_producto})">Editar</button>
                                    <button class="btn-accion btn-borrar" onclick="eliminarProductoDirecto(${prod.id_producto})">Borrar</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('[v0] Error al cargar productos:', err);
                    document.getElementById('tabla-productos-body').innerHTML = 
                        '<tr><td colspan="5" style="text-align:center; color:red;">Error al cargar datos: ' + err.message + '</td></tr>';
                });
        }

        function buscarProductoPorId() {
            const id = document.getElementById('buscar-producto-id').value;
            if (!id) {
                alert('Por favor selecciona un producto');
                return;
            }
            const producto = productosData.find(p => p.id_producto == id);
            if (producto) {
                alert(`PRODUCTO ENCONTRADO:\n\nID: ${producto.id_producto}\nNombre: ${producto.nombre}\nPrecio: $${producto.precio}\nStock: ${producto.stock}\nDescripci贸n: ${producto.descripcion || 'N/A'}`);
            } else {
                alert('Producto no encontrado');
            }
        }

        function editarProducto() {
            const id = document.getElementById('buscar-producto-id').value;
            if (!id) {
                alert('Por favor selecciona un producto');
                return;
            }
            editarProductoDirecto(id);
        }

        function eliminarProducto() {
            const id = document.getElementById('buscar-producto-id').value;
            if (!id) {
                alert('Por favor selecciona un producto');
                return;
            }
            eliminarProductoDirecto(id);
        }

        function editarProductoDirecto(id) {
            const producto = productosData.find(p => p.id_producto == id);
            if (!producto) {
                alert('Producto no encontrado');
                return;
            }
            
            const nuevoNombre = prompt('Nuevo nombre:', producto.nombre);
            if (!nuevoNombre) return;
            
            const nuevoPrecio = prompt('Nuevo precio:', producto.precio);
            if (!nuevoPrecio || !validarPrecio(nuevoPrecio)) return;
            
            const nuevoStock = prompt('Nuevo stock:', producto.stock);
            if (nuevoStock === null) return;
            if (!validarStock(nuevoStock)) return;
            
            const nuevaDescripcion = prompt('Nueva descripci贸n:', producto.descripcion || '');
            
            console.log('[v0] Actualizando producto:', id);
            fetch('../php/productos_actualizar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_producto: id,
                    nombre: nuevoNombre,
                    precio: parseFloat(nuevoPrecio),
                    stock: parseInt(nuevoStock),
                    descripcion: nuevaDescripcion
                })
            })
            .then(res => {
                if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                return res.json();
            })
            .then(data => {
                console.log('[v0] Respuesta de actualizaci贸n:', data);
                if (data.success) {
                    alert('Producto actualizado correctamente');
                    cargarProductos();
                } else {
                    alert('Error: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi贸n: ' + err.message);
            });
        }

        function eliminarProductoDirecto(id) {
            if (!confirm('驴Est谩s seguro de eliminar este producto?')) return;
            
            console.log('[v0] Eliminando producto:', id);
            fetch('../php/productos_eliminar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_producto: id })
            })
            .then(res => {
                if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                return res.json();
            })
            .then(data => {
                console.log('[v0] Respuesta de eliminaci贸n:', data);
                if (data.success) {
                    alert('Producto eliminado correctamente');
                    cargarProductos();
                } else {
                    alert('Error: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi贸n: ' + err.message);
            });
        }

        function mostrarFormularioNuevoProducto() {
            const nombre = prompt('Nombre del producto:');
            if (!nombre) return;
            
            const precio = prompt('Precio:');
            if (!precio || !validarPrecio(precio)) return;
            
            const stock = prompt('Stock inicial:');
            if (stock === null) return;
            if (!validarStock(stock)) return;
            
            const descripcion = prompt('Descripci贸n (opcional):') || '';
            
            console.log('[v0] Creando nuevo producto');
            fetch('../php/productos_crear.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre: nombre,
                    precio: parseFloat(precio),
                    stock: parseInt(stock),
                    descripcion: descripcion
                })
            })
            .then(res => {
                if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                return res.json();
            })
            .then(data => {
                console.log('[v0] Respuesta de creaci贸n:', data);
                if (data.success) {
                    alert('Producto creado correctamente');
                    cargarProductos();
                } else {
                    alert('Error: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi贸n: ' + err.message);
            });
        }

        function cargarCitas() {
            console.log('[v0] Cargando citas desde citas_admin_get.php...');
            fetch('../php/citas_admin_get.php')
                .then(res => {
                    console.log('[v0] Respuesta recibida de citas_admin_get.php, status:', res.status);
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Citas recibidas:', data);
                    citasData = data;
                    const tbody = document.getElementById('tabla-citas-body');
                    
                    tbody.innerHTML = '';

                    if(!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay citas registradas</td></tr>';
                        return;
                    }

                    data.forEach(cita => {
                        const fechaObj = new Date(cita.fecha_hora);
                        const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>#${cita.id_cita}</td>
                                <td>${cita.cliente_nombre}</td>
                                <td>${cita.barbero_nombre}</td>
                                <td>${fechaStr}</td>
                                <td>${cita.servicio}</td>
                                <td>${cita.estado}</td>
                                <td>
                                    <button class="btn-accion btn-editar" onclick="editarCitaDirecto(${cita.id_cita})">Editar</button>
                                    <button class="btn-accion btn-borrar" onclick="eliminarCitaDirecto(${cita.id_cita})">Borrar</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('[v0] Error al cargar citas:', err);
                    console.log('[v0] Mensaje de error:', err.message);
                    const tbody = document.getElementById('tabla-citas-body');
                    if (tbody) {
                        tbody.innerHTML = 
                            '<tr><td colspan="7" style="text-align:center; color:red;">Error al cargar datos: ' + err.message + '</td></tr>';
                    }
                });
        }

        function cargarBarberos() {
            console.log('[v0] Cargando barberos...');
            fetch('../php/barberos_get_admin.php')
                .then(res => {
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Barberos recibidos:', data);
                    barberosData = data;
                    const select = document.getElementById('buscar-barbero');
                    select.innerHTML = '<option value="">-- Seleccionar barbero --</option>';
                    
                    if(data && data.length > 0) {
                        data.forEach(barbero => {
                            select.innerHTML += `<option value="${barbero.id_usuario}">${barbero.nombre}</option>`;
                        });
                    }
                })
                .catch(err => {
                    console.error('[v0] Error al cargar barberos:', err);
                });
        }

        function cargarClientes() {
            console.log('[v0] Cargando clientes...');
            fetch('../php/clientes_get_admin.php')
                .then(res => {
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Clientes recibidos:', data);
                    clientesData = data;
                    const select = document.getElementById('buscar-cliente');
                    select.innerHTML = '<option value="">-- Seleccionar cliente --</option>';
                    
                    if(data && data.length > 0) {
                        data.forEach(cliente => {
                            select.innerHTML += `<option value="${cliente.id_usuario}">${cliente.nombre}</option>`;
                        });
                    }
                })
                .catch(err => {
                    console.error('[v0] Error al cargar clientes:', err);
                });
        }

        function buscarCitaPorId() {
            const id = document.getElementById('buscar-cita-id').value;
            if (!id) {
                alert('Por favor selecciona una cita');
                return;
            }
            const cita = citasData.find(c => c.id_cita == id);
            if (cita) {
                const fechaStr = new Date(cita.fecha_hora).toLocaleString();
                alert(`CITA ENCONTRADA:\n\nID: ${cita.id_cita}\nCliente: ${cita.cliente_nombre}\nBarbero: ${cita.barbero_nombre}\nFecha: ${fechaStr}\nServicio: ${cita.servicio}\nEstado: ${cita.estado}`);
            } else {
                alert('Cita no encontrada');
            }
        }

        function actualizarCita() {
            const id = document.getElementById('buscar-cita-id').value;
            if (!id) {
                alert('Por favor selecciona una cita');
                return;
            }
            editarCitaDirecto(id);
        }

        function eliminarCita() {
            const id = document.getElementById('buscar-cita-id').value;
            if (!id) {
                alert('Por favor selecciona una cita');
                return;
            }
            eliminarCitaDirecto(id);
        }

        function editarCitaDirecto(id) {
            const cita = citasData.find(c => c.id_cita == id);
            if (!cita) {
                alert('Cita no encontrada');
                return;
            }
            
            const nuevoEstado = prompt('Nuevo estado (pendiente/completada/cancelada):', cita.estado);
            if (!nuevoEstado) return;
            
            if(!['pendiente', 'completada', 'cancelada'].includes(nuevoEstado.toLowerCase())) {
                alert('Estado inv谩lido. Debe ser: pendiente, completada o cancelada');
                return;
            }
            
            console.log('[v0] Actualizando estado de cita:', id);
            fetch('../php/citas_actualizar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_cita: id,
                    estado: nuevoEstado.toLowerCase()
                })
            })
            .then(res => {
                if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                return res.json();
            })
            .then(data => {
                console.log('[v0] Respuesta de actualizaci贸n:', data);
                if (data.success) {
                    alert('Cita actualizada correctamente');
                    cargarCitas();
                } else {
                    alert('Error: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi贸n: ' + err.message);
            });
        }

        function eliminarCitaDirecto(id) {
            if (!confirm('驴Est谩s seguro de eliminar esta cita?')) return;
            
            console.log('[v0] Eliminando cita:', id);
            fetch('../php/citas_eliminar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_cita: id })
            })
            .then(res => {
                if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                return res.json();
            })
            .then(data => {
                console.log('[v0] Respuesta de eliminaci贸n:', data);
                if (data.success) {
                    alert('Cita eliminada correctamente');
                    cargarCitas();
                } else {
                    alert('Error: ' + (data.mensaje || 'Error desconocido'));
                }
            })
            .catch(err => {
                console.error('[v0] Error:', err);
                alert('Error de conexi贸n: ' + err.message);
            });
        }

        function buscarCitasPorBarbero() {
            const barberoId = document.getElementById('buscar-barbero').value;
            if (!barberoId) {
                cargarCitas();
                return;
            }
            
            const tbody = document.getElementById('tabla-citas-body');
            tbody.innerHTML = '';
            
            const citasFiltradas = citasData.filter(c => c.id_barbero == barberoId);
            
            if (citasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay citas para este barbero</td></tr>';
                return;
            }

            citasFiltradas.forEach(cita => {
                const fechaObj = new Date(cita.fecha_hora);
                const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                
                tbody.innerHTML += `
                    <tr>
                        <td>#${cita.id_cita}</td>
                        <td>${cita.cliente_nombre}</td>
                        <td>${cita.barbero_nombre}</td>
                        <td>${fechaStr}</td>
                        <td>${cita.servicio}</td>
                        <td>${cita.estado}</td>
                        <td>
                            <button class="btn-accion btn-editar" onclick="editarCitaDirecto(${cita.id_cita})">Editar</button>
                            <button class="btn-accion btn-borrar" onclick="eliminarCitaDirecto(${cita.id_cita})">Borrar</button>
                        </td>
                    </tr>
                `;
            });
        }

        function buscarCitasPorCliente() {
            const clienteId = document.getElementById('buscar-cliente').value;
            if (!clienteId) {
                cargarCitas();
                return;
            }
            
            const tbody = document.getElementById('tabla-citas-body');
            tbody.innerHTML = '';
            
            const citasFiltradas = citasData.filter(c => c.id_cliente == clienteId);
            
            if (citasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay citas para este cliente</td></tr>';
                return;
            }

            citasFiltradas.forEach(cita => {
                const fechaObj = new Date(cita.fecha_hora);
                const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                
                tbody.innerHTML += `
                    <tr>
                        <td>#${cita.id_cita}</td>
                        <td>${cita.cliente_nombre}</td>
                        <td>${cita.barbero_nombre}</td>
                        <td>${fechaStr}</td>
                        <td>${cita.servicio}</td>
                        <td>${cita.estado}</td>
                        <td>
                            <button class="btn-accion btn-editar" onclick="editarCitaDirecto(${cita.id_cita})">Editar</button>
                            <button class="btn-accion btn-borrar" onclick="eliminarCitaDirecto(${cita.id_cita})">Borrar</button>
                        </td>
                    </tr>
                `;
            });
        }

        function buscarCitasPorEstado() {
            const estado = document.getElementById('buscar-estado').value;
            if (!estado) {
                cargarCitas();
                return;
            }
            
            console.log('[v0] Buscando citas por estado:', estado);
            fetch('../php/citas_por_estado_get.php?estado=' + encodeURIComponent(estado))
                .then(res => {
                    if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('[v0] Citas por estado recibidas:', data);
                    const tbody = document.getElementById('tabla-citas-body');
                    tbody.innerHTML = '';
                    
                    if (!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay citas en ese estado</td></tr>';
                        return;
                    }

                    data.forEach(cita => {
                        const fechaObj = new Date(cita.fecha_hora);
                        const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>#${cita.id_cita}</td>
                                <td>${cita.cliente_nombre}</td>
                                <td>${cita.barbero_nombre}</td>
                                <td>${fechaStr}</td>
                                <td>${cita.servicio}</td>
                                <td>${cita.estado}</td>
                                <td>
                                    <button class="btn-accion btn-editar" onclick="editarCitaDirecto(${cita.id_cita})">Editar</button>
                                    <button class="btn-accion btn-borrar" onclick="eliminarCitaDirecto(${cita.id_cita})">Borrar</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('[v0] Error:', err);
                    document.getElementById('tabla-citas-body').innerHTML = 
                        '<tr><td colspan="7" style="text-align:center; color:red;">Error al cargar datos: ' + err.message + '</td></tr>';
                });
        }

        function cargarUsuarios() {
            console.log('[v0] Cargando usuarios desde usuarios_get.php...');
            fetch('../php/usuarios_get.php')
                .then(res => {
                    console.log('[v0] Respuesta recibida de usuarios_get.php, status:', res.status);
                    return res.text().then(text => {
                        console.log('[v0] Respuesta raw:', text);
                        try {
                            return JSON.parse(text);
                        } catch(e) {
                            console.error('[v0] Error parseando JSON:', e);
                            throw new Error('La respuesta no es JSON v谩lido. Revisa que el archivo PHP no tenga errores de sintaxis o output HTML.');
                        }
                    });
                })
                .then(data => {
                    console.log('[v0] Usuarios recibidos:', data);
                    if(data.error) {
                        throw new Error(data.error);
                    }
                    
                    usuariosData = data;
                    const tbody = document.getElementById('tabla-usuarios-body');
                    
                    tbody.innerHTML = '';

                    if(!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay usuarios registrados</td></tr>';
                        return;
                    }

                    data.forEach(usuario => {
                        const rolNombre = usuario.rol_texto || 'N/A';
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>#${usuario.id_usuario}</td>
                                <td>${usuario.nombre}</td>
                                <td>${usuario.email}</td>
                                <td>${usuario.telefono || 'N/A'}</td>
                                <td>${rolNombre}</td>
                                <td>
                                    <button onclick="editarUsuario(${usuario.id_usuario})" class="btn-accion">Editar</button>
                                    <button onclick="eliminarUsuarioDirecto(${usuario.id_usuario})" class="btn-accion btn-eliminar">Eliminar</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('[v0] Error al cargar usuarios:', err);
                    document.getElementById('tabla-usuarios-body').innerHTML = 
                        '<tr><td colspan="6" style="text-align:center; color:red;">Error al cargar datos: ' + err.message + '</td></tr>';
                });
        }

        function buscarUsuarioPorId() {
            const id = document.getElementById('buscar-usuario-id').value;
            if(!id) {
                alert('Selecciona un usuario');
                return;
            }
            const usuario = usuariosData.find(u => u.id_usuario == id);
            if(usuario) {
                const tbody = document.getElementById('tabla-usuarios-body');
                const rolNombre = usuario.rol_texto || 'N/A';
                tbody.innerHTML = `
                    <tr>
                        <td>#${usuario.id_usuario}</td>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.email}</td>
                        <td>${usuario.telefono || 'N/A'}</td>
                        <td>${rolNombre}</td>
                        <td>
                            <button class="btn-accion btn-editar" onclick="editarUsuario(${usuario.id_usuario})">Editar</button>
                            <button class="btn-accion btn-borrar" onclick="eliminarUsuarioDirecto(${usuario.id_usuario})">Borrar</button>
                        </td>
                    </tr>
                `;
            } else {
                 alert('Usuario no encontrado');
            }
        }

        function editarUsuario(id) {
            const usuario = usuariosData.find(u => u.id_usuario == id);
            if (!usuario) {
                alert('Usuario no encontrado');
                return;
            }
            
            const nuevoNombre = prompt('Nuevo nombre:', usuario.nombre);
            if (nuevoNombre === null) return;
            
            const nuevoEmail = prompt('Nuevo email:', usuario.email);
            if (nuevoEmail === null) return;
            
            const nuevoTelefono = prompt('Nuevo tel茅fono:', usuario.telefono || '');
            if (nuevoTelefono === null) return;
            
            const nuevoRol = prompt('Nuevo rol (1=Admin, 2=Barbero, 3=Cliente):', usuario.id_rol);
            if (nuevoRol === null) return;

            const rolInt = parseInt(nuevoRol);
            if (![1, 2, 3].includes(rolInt)) {
                alert('Rol inv谩lido. Introduce 1, 2 o 3.');
                return;
            }
            
            if (!nuevoNombre || !nuevoEmail) {
                alert('Nombre y email son obligatorios');
                return;
            }
            
            const updateData = {
                id_usuario: id,
                nombre: nuevoNombre,
                email: nuevoEmail,
                telefono: nuevoTelefono,
                id_rol: rolInt
            };
            
            console.log('[v0] Enviando actualizaci贸n:', updateData);
            
            fetch('../php/usuarios_actualizar.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(res => {
                console.log('[v0] Status:', res.status);
                return res.text().then(text => {
                    console.log('[v0] Respuesta raw:', text);
                    try {
                        const data = JSON.parse(text);
                        if (!res.ok) {
                            throw new Error(data.message || 'Error HTTP: ' + res.status);
                        }
                        return data;
                    } catch (e) {
                        if (!res.ok) {
                            throw new Error('Error del servidor. Revisa los logs de PHP.');
                        }
                        throw new Error('Respuesta no v谩lida del servidor: ' + text);
                    }
                });
            })
            .then(data => {
                console.log('[v0] Respuesta exitosa:', data);
                if (data.success) {
                    alert('Usuario actualizado correctamente');
                    cargarUsuarios();
                } else {
                    alert('Error: ' + (data.message || 'No se pudo actualizar'));
                }
            })
            .catch(err => {
                console.error('[v0] Error completo:', err);
                alert('Error de conexi贸n: ' + err.message);
            });
        }

        function eliminarUsuarioDirecto(id) {
            if (!confirm('驴Est谩s seguro que deseas eliminar este usuario?')) {
                return;
            }
            
            console.log('[v0] Eliminando usuario:', id);
            fetch('../php/usuarios_eliminar.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id_usuario: id })
            })
            .then(res => {
                if (!res.ok) throw new Error('Error HTTP: ' + res.status);
                return res.json();
            })
            .then(data => {
                console.log('[v0] Respuesta de eliminaci贸n:', data);
                if (data.success) {
                    alert('Usuario eliminado correctamente');
                    cargarUsuarios(); // Reload the table
                } else {
                    alert('Error: ' + (data.mensaje || 'No se pudo eliminar'));
                }
            })
            .catch(err => {
                console.error('[v0] Error eliminando usuario:', err);
                alert('Error de conexi贸n: ' + err.message);
            });
        }

        function buscarUsuariosPorRol() {
            const rol = document.getElementById('buscar-rol').value;
            const tbody = document.getElementById('tabla-usuarios-body');
            
            tbody.innerHTML = '';
            
            if(!rol) {
                cargarUsuarios();
                return;
            }
            
            const filtrados = usuariosData.filter(u => u.id_rol == rol);
            
            if(filtrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay usuarios con ese rol</td></tr>';
                return;
            }
            
            filtrados.forEach(usuario => {
                const rolNombre = usuario.rol_texto || 'N/A';
                tbody.innerHTML += `
                    <tr>
                        <td>#${usuario.id_usuario}</td>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.email}</td>
                        <td>${usuario.telefono || 'N/A'}</td>
                        <td>${rolNombre}</td>
                        <td>
                            <button onclick="editarUsuario(${usuario.id_usuario})" class="btn-accion">Editar</button>
                            <button onclick="eliminarUsuarioDirecto(${usuario.id_usuario})" class="btn-accion btn-eliminar">Eliminar</button>
                        </td>
                    </tr>
                `;
            });
        }

        function mostrarReporte(tipo) {
            const reporteIngresos = document.getElementById('reporte-ingresos');
            const reporteEstadisticas = document.getElementById('reporte-estadisticas');
            const btnIngresos = document.getElementById('btn-reporte-ingresos');
            const btnEstadisticas = document.getElementById('btn-reporte-estadisticas');

            if (tipo === 'ingresos') {
                reporteIngresos.style.display = 'block';
                reporteEstadisticas.style.display = 'none';
                btnIngresos.style.background = '#00d4ff';
                btnIngresos.style.color = '#000';
                btnEstadisticas.style.background = '#333';
                btnEstadisticas.style.color = '#fff';
                cargarReporteIngresos();
            } else {
                reporteIngresos.style.display = 'none';
                reporteEstadisticas.style.display = 'block';
                btnIngresos.style.background = '#333';
                btnIngresos.style.color = '#fff';
                btnEstadisticas.style.background = '#00d4ff';
                btnEstadisticas.style.color = '#000';
                cargarReporteEstadisticas();
            }
        }

        function cargarReporteIngresos() {
            const tbody = document.getElementById('tabla-reporte-ingresos-body');
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 20px;">Cargando reporte...</td></tr>';

            fetch('../php/reporte_ingresos_get.php')
                .then(res => res.json())
                .then(data => {
                    console.log('[v0] Datos del reporte recibidos:', data);
                    tbody.innerHTML = '';

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    if (!data.reporte || data.reporte.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No hay datos suficientes para generar el reporte.</td></tr>';
                        return;
                    }

                    window.reporteIngresosData = data.reporte;
                    
                    let totalIngresos = 0;
                    data.reporte.forEach(item => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${item.servicio}</td>
                                <td>${item.citas_realizadas}</td>
                                <td>$${parseFloat(item.ingresos_generados).toFixed(2)}</td>
                            </tr>
                        `;
                        totalIngresos += parseFloat(item.ingresos_generados);
                    });
                    
                    tbody.innerHTML += `
                        <tr style="background: #00d4ff20; font-weight: bold; border-top: 2px solid #00d4ff;">
                            <td>TOTAL</td>
                            <td>-</td>
                            <td>$${totalIngresos.toFixed(2)}</td>
                        </tr>
                    `;
                })
                .catch(err => {
                    console.error('[v0] Error al cargar el reporte:', err);
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:red;">Error al cargar el reporte: ' + err.message + '</td></tr>';
                });
        }
        
        function descargarReporteIngresos() {
            if (!window.reporteIngresosData || window.reporteIngresosData.length === 0) {
                alert('No hay datos para descargar. Por favor, carga el reporte primero.');
                return;
            }

            const datos = window.reporteIngresosData;
            
        
            let csv = 'Servicio,Citas Realizadas,Ingresos Generados\n';
            
            let totalCitas = 0;
            let totalIngresos = 0;
            
            datos.forEach(item => {
                const servicio = `"${item.servicio.replace(/"/g, '""')}"`;
                const citas = item.citas_realizadas;
                const ingresos = parseFloat(item.ingresos_generados).toFixed(2);
                
                csv += `${servicio},${citas},${ingresos}\n`;
                
                totalCitas += parseInt(citas);
                totalIngresos += parseFloat(ingresos);
            });
            
            // A帽ade el total
            csv += `"TOTAL",${totalCitas},${totalIngresos.toFixed(2)}\n`;
            
            // A帽ade metadatos
            csv += '\n\nGenerado en: ' + new Date().toLocaleString('es-MX') + '\n';
            csv += 'Reporte de Ingresos por Servicio - La Quinta Esencia Barber Shop';
            
            // Crea link de descarga
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `reporte-ingresos-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('[v0] Reporte descargado exitosamente');
        }

        function cargarReporteEstadisticas() {
            fetch('../php/reporte_citas_get.php')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    const stats = data.estadisticas;
                    
                    // Actualiza el estado
                    document.getElementById('stat-total').textContent = stats.total_general || '0';
                    
                    let completadas = 0, pendientes = 0, canceladas = 0;
                    stats.por_estado.forEach(item => {
                        if (item.estado === 'completada') completadas = item.cantidad;
                        else if (item.estado === 'pendiente') pendientes = item.cantidad;
                        else if (item.estado === 'cancelada') canceladas = item.cantidad;
                    });
                    
                    document.getElementById('stat-completadas').textContent = completadas;
                    document.getElementById('stat-pendientes').textContent = pendientes;
                    document.getElementById('stat-canceladas').textContent = canceladas;

                    // Llena la tabla estado
                    const tbodyEstado = document.getElementById('tabla-estado-body');
                    tbodyEstado.innerHTML = '';
                    stats.por_estado.forEach(item => {
                        const porcentaje = ((item.cantidad / stats.total_general) * 100).toFixed(1);
                        tbodyEstado.innerHTML += `
                            <tr>
                                <td style="text-transform: capitalize;">${item.estado}</td>
                                <td>${item.cantidad}</td>
                                <td>${porcentaje}%</td>
                            </tr>
                        `;
                    });

                    // LLena tabla barbero
                    const tbodyBarbero = document.getElementById('tabla-barbero-body');
                    tbodyBarbero.innerHTML = '';
                    if (stats.por_barbero.length === 0) {
                        tbodyBarbero.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay datos disponibles</td></tr>';
                    } else {
                        stats.por_barbero.forEach(item => {
                            const tasa = ((item.completadas / item.total_citas) * 100).toFixed(1);
                            tbodyBarbero.innerHTML += `
                                <tr>
                                    <td>${item.barbero}</td>
                                    <td>${item.total_citas}</td>
                                    <td>${item.completadas}</td>
                                    <td>${tasa}%</td>
                                </tr>
                            `;
                        });
                    }

                    // Llena las tablas
                    const tbodyMes = document.getElementById('tabla-mes-body');
                    tbodyMes.innerHTML = '';
                    if (stats.por_mes.length === 0) {
                        tbodyMes.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay datos disponibles</td></tr>';
                    } else {
                        stats.por_mes.forEach(item => {
                            const tasa = ((item.completadas / item.total_citas) * 100).toFixed(1);
                            // Formato de fecha
                            const [year, month] = item.mes.split('-');
                            const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                            const monthName = monthNames[parseInt(month) - 1];
                            
                            tbodyMes.innerHTML += `
                                <tr>
                                    <td>${monthName} ${year}</td>
                                    <td>${item.total_citas}</td>
                                    <td>${item.completadas}</td>
                                    <td>${tasa}%</td>
                                </tr>
                            `;
                        });
                    }
                })
                .catch(err => {
                    console.error('Error al cargar estad铆sticas:', err);
                    alert('Error al cargar las estad铆sticas: ' + err.message);
                });
        }

        window.addEventListener('DOMContentLoaded', function() {
            console.log('[v0] P谩gina cargada, iniciando carga de productos');
            mostrarSeccion('productos'); // Cargar la primera secci贸n por defecto
        });
    </script>
<!-- Incluir los modales en el HTML -->
<script src="../JS/edit-modals.js"></script>
</body>
</html>

