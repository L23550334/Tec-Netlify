<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Barbero - La Quinta Esencia Barber Shop</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body { background-color: #0a0a0a; color: white; }
        .admin-layout { display: flex; min-height: calc(100vh - 80px); }
        
        .sidebar { width: 250px; background-color: #151515; border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .sidebar button { background: none; border: 1px solid #333; color: #ccc; padding: 15px; text-align: left; cursor: pointer; border-radius: 5px; width: 100%; transition: 0.3s; }
        .sidebar button:hover, .sidebar button.active { background-color: var(--color-primario); color: #0a0a0a; font-weight: bold; border-color: var(--color-primario); }

        .content { flex: 1; padding: 2rem; }
        h2 { color: var(--color-primario); margin-bottom: 0.5rem; }
        .subtitulo { color: #888; margin-bottom: 2rem; }

        .search-box {
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .search-box label {
            display: block;
            color: var(--color-primario);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .search-box select,
        .search-box input {
            width: 100%;
            padding: 10px;
            background-color: #0a0a0a;
            border: 1px solid #333;
            color: white;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .search-box button {
            padding: 10px 20px;
            background-color: var(--color-primario);
            color: #0a0a0a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }

        .search-box button:hover {
            opacity: 0.9;
        }

        .table-container { overflow-x: auto; background-color: #1a1a1a; border-radius: 8px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; color: #eee; }
        thead { background-color: #252525; border-bottom: 2px solid var(--color-primario); }
        th { padding: 15px; text-align: left; color: var(--color-primario); font-weight: bold; text-transform: uppercase; font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid #333; }
        tr:hover { background-color: #222; }

        .btn-estado { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; margin-right: 5px; }
        .btn-completar { background-color: #4CAF50; color: white; }
        .btn-cancelar { background-color: #ff4d4d; color: white; }
        
        .section-panel { display: none; }
        .section-panel.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .estado-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .estado-badge.pendiente { background-color: #ff9800; color: white; }
        .estado-badge.confirmada { background-color: #2196f3; color: white; }
        .estado-badge.completada { background-color: #4caf50; color: white; }
        .estado-badge.cancelada { background-color: #ff4d4d; color: white; }
        
        .btn-accion {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.75rem;
            margin: 2px;
        }
        .btn-accion.completar { background-color: #4caf50; color: white; }
        .btn-accion.cancelar { background-color: #ff4d4d; color: white; }
        .btn-accion.confirmar { background-color: #2196f3; color: white; }
        .btn-accion:hover { opacity: 0.85; }
        
        .welcome-msg {
            background: linear-gradient(135deg, #1a1a1a, #252525);
            border: 1px solid var(--color-primario);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .welcome-msg h3 { color: var(--color-primario); margin: 0; }
        .welcome-msg span { color: #888; font-size: 0.9rem; }
    </style>
</head>
<body>

    <header>
        <nav>
            <a href="../index.html" class="logo">La Quinta Esencia Barber Shop </a>
            <div class="nav-links-group">
                <ul style="list-style: none; display: flex; gap: 20px;">
                    <li><a href="../index.html" style="text-decoration: none; color: var(--color-primario);"> Volver al Inicio</a></li>
                    <li><a href="#" onclick="cerrarSesion()" style="text-decoration: none; color: #888;"> Cerrar Sesi贸n</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main class="admin-layout">
        <aside class="sidebar">
            <button onclick="mostrarSeccion('agenda')" class="active"> Mi Agenda</button>
            <button onclick="mostrarSeccion('productos')"> Productos</button>
        </aside>

        <section class="content">
            <!-- Agregado mensaje de bienvenida con nombre del barbero -->
            <div class="welcome-msg">
                <h3>Bienvenido, <span id="nombre-barbero">Barbero</span></h3>
                <span id="fecha-actual"></span>
            </div>
            
            <div id="panel-agenda" class="section-panel active">
                <h2 style="color:black">Citas Programadas</h2>
                <h4 style="color:black">Gestiona tus clientes asignados.</h4>
                
                <div class="search-box">
                    <label for="filtro-estado">Filtrar por estado:</label>
                    <select id="filtro-estado" onchange="filtrarCitasPorEstado()">
                        <option value="">-- Todas las citas --</option>
                        <option value="pendiente">Pendientes</option>
                        <option value="confirmada">Confirmadas</option>
                        <option value="completada">Completadas</option>
                        <option value="cancelada">Canceladas</option>
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Servicio</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-citas-barbero-body">
                            <tr><td colspan="7" style="text-align:center; padding: 20px;">Cargando citas...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="panel-productos" class="section-panel">
                <h2 style="color:black">Cat谩logo de Productos</h2>
               <h4 style="color:black">Productos disponibles para recomendar.</h4>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Descripci贸n</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos-barbero-body">
                            <tr><td colspan="5" style="text-align:center;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        let misCitasData = [];
        let productosData = [];
        let barberoActual = null;

        function inicializarDashboard() {
            const usuario = JSON.parse(localStorage.getItem('loggedInUser') || '{}');
            
            const esBarbero = usuario.rol == 2 || usuario.role === 'barbero';
            
            if (!usuario.id_usuario || !esBarbero) {
                alert('Acceso denegado. Debes iniciar sesion como barbero.');
                window.location.href = '../index.html';
                return;
            }
            
            barberoActual = usuario;
            document.getElementById('nombre-barbero').textContent = usuario.nombre || usuario.username || 'Barbero';
            
            const hoy = new Date();
            document.getElementById('fecha-actual').textContent = hoy.toLocaleDateString('es-MX', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            
            cargarCitasDelBarbero();
        }

        function mostrarSeccion(id) {
            document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            document.getElementById('panel-' + id).classList.add('active');
            event.target.classList.add('active');

            if (id === 'agenda') {
                cargarCitasDelBarbero();
            } else if (id === 'productos') {
                cargarProductosBarbero();
            }
        }

        function cargarCitasDelBarbero() {
            const tbody = document.getElementById('tabla-citas-barbero-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Cargando...</td></tr>';
            
            const url = barberoActual 
                ? `../php/citas_barbero_get.php?id_barbero=${barberoActual.id_usuario}`
                : '../php/citas_barbero_get.php';
            
            fetch(url, { credentials: 'include' })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    
                    misCitasData = Array.isArray(data) ? data : [];
                    renderizarCitas(misCitasData);
                })
                .catch(error => {
                    console.error("Error cargando citas:", error);
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Error: ${error.message}</td></tr>`;
                });
        }

        function renderizarCitas(citas) {
            const tbody = document.getElementById('tabla-citas-barbero-body');
            
            if (citas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: #888;">No tienes citas asignadas</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            citas.forEach(cita => {
                const fechaHora = new Date(cita.fecha_hora);
                const fecha = fechaHora.toLocaleDateString('es-MX');
                const hora = fechaHora.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                
                let acciones = '';
                if (cita.estado === 'pendiente') {
                    acciones = `
                        <button class="btn-accion confirmar" onclick="actualizarEstadoCita(${cita.id_cita}, 'confirmada')">Confirmar</button>
                        <button class="btn-accion completar" onclick="actualizarEstadoCita(${cita.id_cita}, 'completada')">Completar</button>
                        <button class="btn-accion cancelar" onclick="actualizarEstadoCita(${cita.id_cita}, 'cancelada')">Cancelar</button>
                    `;
                } else if (cita.estado === 'confirmada') {
                    acciones = `
                        <button class="btn-accion completar" onclick="actualizarEstadoCita(${cita.id_cita}, 'completada')">Completar</button>
                        <button class="btn-accion cancelar" onclick="actualizarEstadoCita(${cita.id_cita}, 'cancelada')">Cancelar</button>
                    `;
                } else {
                    acciones = `<span style="color: #666; font-size: 0.85em;">${cita.estado === 'completada' ? 'Finalizada' : 'Cancelada'}</span>`;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${cita.id_cita}</td>
                        <td>${cita.cliente_nombre}</td>
                        <td>${cita.servicio}</td>
                        <td>${fecha}</td>
                        <td>${hora}</td>
                        <td><span class="estado-badge ${cita.estado}">${cita.estado}</span></td>
                        <td>${acciones}</td>
                    </tr>
                `;
            });
        }

        function filtrarCitasPorEstado() {
            const estado = document.getElementById('filtro-estado').value;
            
            if (!estado) {
                renderizarCitas(misCitasData);
            } else {
                const filtradas = misCitasData.filter(c => c.estado === estado);
                renderizarCitas(filtradas);
            }
        }

        function actualizarEstadoCita(idCita, nuevoEstado) {
            const mensajes = {
                'confirmada': 'confirmar',
                'completada': 'marcar como completada',
                'cancelada': 'cancelar'
            };
            
            if (!confirm(`驴Deseas ${mensajes[nuevoEstado]} esta cita?`)) return;
            
            fetch('../php/citas_actualizar.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ id_cita: idCita, estado: nuevoEstado })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Cita actualizada correctamente');
                    cargarCitasDelBarbero();
                } else {
                    alert('Error: ' + (data.mensaje || 'No se pudo actualizar'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error de conexi贸n');
            });
        }

        function cargarProductosBarbero() {
            fetch('../php/productos_get.php')
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    
                    productosData = Array.isArray(data) ? data : [];
                    const tbody = document.getElementById('tabla-productos-barbero-body');
                    
                    if (productosData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay productos</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    productosData.forEach(prod => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${prod.id_producto}</td>
                                <td>${prod.nombre}</td>
                                <td>$${parseFloat(prod.precio).toFixed(2)}</td>
                                <td>${prod.stock}</td>
                                <td>${prod.descripcion || '-'}</td>
                            </tr>
                        `;
                    });
                })
                .catch(err => {
                    console.error('Error:', err);
                    document.getElementById('tabla-productos-barbero-body').innerHTML = 
                        `<tr><td colspan="5" style="text-align:center; color:red;">Error: ${err.message}</td></tr>`;
                });
        }

        function cerrarSesion() {
            if (confirm("驴Cerrar sesi贸n?")) {
                localStorage.removeItem('loggedInUser');
                window.location.href = '../index.html';
            }
        }

        document.addEventListener('DOMContentLoaded', inicializarDashboard);
    </script>

</body>
</html>
