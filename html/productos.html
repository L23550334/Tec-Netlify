<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - La Quinta Esencia Barber Shop</title>
    
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Estilo para centrar el bot√≥n dentro de la tarjeta del producto */
        .product-card {
            text-align: center;
        }
    </style>
</head>
<body>

    <header>
        <nav>
            <!-- Icono de Men√∫ Hamburguesa -->
            <div id="hamburger-btn">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <!-- Logo Centrado -->
            <a href="/index.html" class="logo">La Quinta Esencia Barber Shop</a> 
            <!-- Espacio a la derecha para el bot√≥n del carrito -->
            <div class="nav-placeholder">
                <a href="#" id="cart-btn" class="btn-cita">Carrito (<span id="cart-count">0</span>)</a>
            </div>
        </nav>
    </header>

    <!-- Men√∫ Lateral Desplegable -->
    <div id="side-menu" class="side-nav">
        <a href="#" class="close-side-menu">&times;</a>
        <ul>
            <li><a href="/index.html">Inicio</a></li> 
        </ul>
        <!-- El inicio de sesi√≥n se gestiona aqu√≠, pero no se muestra si est√° el carrito -->
        <div id="auth-container" class="side-menu-auth"></div>
    </div>

    <main>

        <section id="catalogo">
            <h2>Nuestro Cat√°logo</h2>
            <p class="subtitulo-catalogo">Productos premium para tu cuidado diario.</p>

            <!-- Eliminados productos hardcodeados, ahora se cargan din√°micamente -->
            <div class="product-grid" id="product-grid-container">
                <p style="text-align: center; padding: 40px;">Cargando productos...</p>
            </div>
        </section>

    </main>

    <footer>
        <p>&copy; 2025 La Quinta Esencia Barber Shop. Todos los derechos reservados.</p>
    </footer>

    <script src="/JS/validaciones.js"></script>
    <script src="/JS/script.js"></script> 

    <!-- Script para cargar productos din√°micamente desde la BD -->
    <script>
        // Cargar productos din√°micamente al iniciar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            cargarProductosDinamicos();
            
            const pickupButton = document.getElementById('pickup-btn');
            const deliveryButton = document.getElementById('delivery-btn');
            const deliveryModal = document.getElementById('delivery-modal');
            const deliveryForm = document.getElementById('form-delivery');
            const closeDeliveryModal = deliveryModal.querySelector('.close-modal');

            const cartModal = document.getElementById('cart-modal');
            
            // Elementos del modal de alerta gen√©rico
            const alertModal = document.getElementById('alert-modal');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalMessage = document.getElementById('alert-modal-message');
            const alertModalClose = document.getElementById('alert-modal-close');

            if (pickupButton && cartModal && alertModal && deliveryButton && deliveryModal && deliveryForm) {
                pickupButton.addEventListener('click', () => {
                    const cartTotalElement = document.getElementById('cart-total');
                    const totalText = cartTotalElement ? cartTotalElement.textContent : 'Total no disponible';

                    // Ocultamos el modal del carrito
                    cartModal.style.display = 'none';

                    // Preparamos y mostramos el modal de alerta
                    alertModalTitle.textContent = '¬°Pedido Confirmado!';
                    alertModalMessage.innerHTML = `¬°Gracias por tu compra! üõçÔ∏è<br><br>Tus productos est√°n listos para ser recogidos en la tienda.<br><br><strong>Total a pagar: ${totalText}</strong>`;
                    alertModal.style.display = 'flex';
                });

                // --- L√≥gica para Servicio a Domicilio ---

                // 1. Abrir el modal de datos de entrega
                deliveryButton.addEventListener('click', () => {
                    cartModal.style.display = 'none'; // Ocultar modal del carrito
                    deliveryModal.style.display = 'flex'; // Mostrar modal de entrega
                });

                // 2. Manejar el env√≠o del formulario de entrega
                deliveryForm.addEventListener('submit', (event) => {
                    event.preventDefault(); // Evitar que la p√°gina se recargue

                    const cartTotalElement = document.getElementById('cart-total');
                    const totalText = cartTotalElement ? cartTotalElement.textContent : 'Total no disponible';

                    deliveryModal.style.display = 'none'; // Ocultar modal de entrega

                    // Mostrar modal de alerta con mensaje de √©xito
                    alertModalTitle.textContent = '¬°Guardado con √©xito!';
                    alertModalMessage.innerHTML = `Tu pedido ha sido confirmado y llegar√° pronto. üöö<br><br><strong>${totalText}</strong>`;
                    alertModal.style.display = 'flex';
                });

                // Funcionalidad para cerrar el modal de alerta
                const closeAlertAndReset = () => {
                    vaciarCarrito();
                    alertModal.style.display = 'none'; // Ocultamos el modal de alerta
                };

                alertModalClose.addEventListener('click', closeAlertAndReset);

                // Funcionalidad para cerrar el modal de entrega con la 'X'
                closeDeliveryModal.addEventListener('click', () => {
                    deliveryModal.style.display = 'none';
                });
            }

            // Funci√≥n para vaciar el carrito
            function vaciarCarrito() {
                // Limpiamos el almacenamiento local
                localStorage.removeItem('cart');

                // Actualizamos el contador del carrito en el header
                document.getElementById('cart-count').textContent = '0';

                // Limpiamos los contenedores visuales del carrito
                document.getElementById('cart-items-container').innerHTML = '<p>Tu carrito est√° vac√≠o.</p>';
                document.getElementById('cart-total').innerHTML = '<strong>Total: $0.00</strong>';
                console.log('El carrito ha sido vaciado.');
            }
        });

        function cargarProductosDinamicos() {
            const productGrid = document.getElementById('product-grid-container');
            
            fetch('../php/productos_get.php')
                .then(response => {
                    if (!response.ok) throw new Error('Error HTTP: ' + response.status);
                    return response.json();
                })
                .then(productos => {
                    console.log('Productos cargados:', productos);
                    
                    if (!productos || productos.length === 0) {
                        productGrid.innerHTML = '<p style="text-align: center; padding: 40px;">No hay productos disponibles en este momento.</p>';
                        return;
                    }

                    // Generar las tarjetas de productos din√°micamente
                    productGrid.innerHTML = '';
                    productos.forEach(producto => {
                        const imagenUrl = obtenerImagenProducto(producto.nombre, producto.imagen_url);
                        const descripcionCorta = producto.descripcion || 'Producto de calidad premium para tu cuidado.';
                        
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.setAttribute('data-id', producto.id_producto);
                        card.setAttribute('data-name', producto.nombre);
                        card.setAttribute('data-price', producto.precio);
                        card.setAttribute('data-img', imagenUrl);
                        
                        const img = document.createElement('img');
                        img.src = imagenUrl;
                        img.alt = producto.nombre;
                        img.onerror = function() { this.src = '../img/cera2.webp'; };

                        const h3 = document.createElement('h3');
                        h3.textContent = producto.nombre;

                        const p = document.createElement('p');
                        p.textContent = descripcionCorta;

                        const span = document.createElement('span');
                        span.className = 'precio';
                        span.textContent = `$${parseFloat(producto.precio).toFixed(2)}`;

                        const button = document.createElement('button');
                        button.className = 'btn-comprar';
                        if (producto.stock > 0) {
                            button.textContent = 'Agregar al carrito';
                        } else {
                            button.textContent = 'Sin stock';
                            button.disabled = true;
                            button.style.opacity = '0.5';
                            button.style.cursor = 'not-allowed';
                        }

                        card.append(img, h3, p, span, button);
                        
                        productGrid.appendChild(card);
                    });

                    activarBotonesCompra();
                })
                .catch(error => {
                    console.error('Error al cargar productos:', error);
                    productGrid.innerHTML = '<p style="text-align: center; padding: 40px; color: red;">Error al cargar los productos. Por favor intenta m√°s tarde.</p>';
                });
        }

        function obtenerImagenProducto(nombreProducto, imagenUrl) {
            const nombre = nombreProducto.toLowerCase();
            
            // Mapeo basado en el nombre del producto a las im√°genes reales disponibles
            if (nombre.includes('cera') || nombre.includes('mate')) {
                return '../img/cera2.webp';
            }
            if (nombre.includes('aceite') || nombre.includes('barba')) {
                return '../img/aceite.png';
            }
            if (nombre.includes('shampoo') || nombre.includes('anti-ca√≠da') || nombre.includes('anticaida')) {
                return '../img/shampoo.webp';
            }
            if (nombre.includes('after') || nombre.includes('tonico') || nombre.includes('t√≥nico') || nombre.includes('loci√≥n')) {
                return '../img/tonico.webp';
            }
            if (nombre.includes('navaja') || nombre.includes('cepillo')) {
                return '../img/cepillo.png';
            }
            if (nombre.includes('growth') || nombre.includes('oil')) {
                return '../img/Growth_Oil.webp';
            }
            
            // Fallback: imagen por defecto
            return '../img/cera2.webp';
        }

        function activarBotonesCompra() {
            const buyButtons = document.querySelectorAll('.btn-comprar');
            const quantityModal = document.getElementById('quantity-modal');
            const quantityForm = document.getElementById('form-quantity');
            const quantityInput = document.getElementById('quantity-input');
            const closeModalBtn = quantityModal.querySelector('.close-modal');
            const minusBtn = document.getElementById('quantity-minus');
            const plusBtn = document.getElementById('quantity-plus');

            let currentProduct = null;

            buyButtons.forEach(button => {
                if (button.disabled) return; // Ignorar botones deshabilitados (sin stock)
                
                button.addEventListener('click', (event) => {
                    const productCard = event.target.closest('.product-card');
                    currentProduct = {
                        id: productCard.dataset.id,
                        name: productCard.dataset.name,
                        price: parseFloat(productCard.dataset.price),
                        img: productCard.dataset.img
                    };

                    quantityInput.value = 1;
                    quantityModal.style.display = 'flex';
                });
            });

            minusBtn.addEventListener('click', () => {
                let currentValue = parseInt(quantityInput.value);
                if (currentValue > 1) {
                    quantityInput.value = currentValue - 1;
                }
            });

            plusBtn.addEventListener('click', () => {
                let currentValue = parseInt(quantityInput.value);
                quantityInput.value = currentValue + 1;
            });

            closeModalBtn.addEventListener('click', () => {
                quantityModal.style.display = 'none';
            });

            quantityForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const quantity = parseInt(quantityInput.value);
                if (currentProduct && quantity > 0) {
                    addToCart(currentProduct, quantity);
                    quantityModal.style.display = 'none';
                    
                    // Mostrar confirmaci√≥n visual
                    alert(`‚úÖ ${currentProduct.name} (x${quantity}) agregado al carrito`);
                }
            });

            // Cerrar modal al hacer clic fuera
            quantityModal.addEventListener('click', (event) => {
                if (event.target === quantityModal) {
                    quantityModal.style.display = 'none';
                }
            });
        }
    </script>


    <!-- Estructura del Modal del Carrito (Oculto por defecto) -->
    <div id="cart-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Carrito de Compras</h2>
            <div id="cart-items-container">
                <!-- Los items del carrito se insertar√°n aqu√≠ -->
            </div>
            <div id="cart-total">
                <!-- El total se mostrar√° aqu√≠ -->
            </div>
            <div id="checkout-options" style="margin-top: 1.5rem; display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                <button id="pickup-btn" class="btn-cita">Recoger en tienda</button>
                <button id="delivery-btn" class="btn-cita">Servicio a Domicilio</button>
            </div>
        </div>
    </div>

    <!-- Estructura del Modal de Cantidad (Oculto por defecto) -->
    <div id="quantity-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;">
            <span class="close-modal">&times;</span>
            <h2 id="quantity-modal-title">Seleccionar Cantidad</h2>
            <form id="form-quantity" class="form-container">
                <div class="form-group">
                    <label>Cantidad</label>
                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn" id="quantity-minus">-</button>
                        <input type="text" id="quantity-input" value="1" min="1" readonly>
                        <button type="button" class="quantity-btn" id="quantity-plus">+</button>
                    </div>
                </div>
                <button type="submit" class="btn-enviar">Aceptar</button>
            </form>
        </div>
    </div>

    <!-- Estructura del Modal de Servicio a Domicilio (Oculto por defecto) -->
    <div id="delivery-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal">&times;</span>
            <h2>Datos de Entrega</h2>
            <p class="subtitulo-catalogo" style="margin-bottom: 1rem;">Ingresa tus datos para el env√≠o.</p>
            <form id="form-delivery" class="form-container" style="text-align: left;">
                <div class="form-group">
                    <label for="delivery-nombre">Nombre de quien recibe</label>
                    <input type="text" id="delivery-nombre" required
                           minlength="3" maxlength="50"
                           pattern="[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+"
                           title="Solo letras, m√≠nimo 3 caracteres"
                           placeholder="Ej: Juan P√©rez">
                </div>
                <div class="form-group">
                    <label for="delivery-calle">Calle</label>
                    <input type="text" id="delivery-calle" required
                           minlength="3" maxlength="100"
                           title="M√≠nimo 3 caracteres"
                           placeholder="Ej: Av. Reforma">
                </div>
                <div class="form-group">
                    <label for="delivery-colonia">Colonia</label>
                    <select id="delivery-colonia" required title="Selecciona una colonia">
                        <option value="">-- Selecciona una colonia --</option>
                        <option value="Aeropuerto">Aeropuerto</option>
                        <option value="Alamedas">Alamedas</option>
                        <option value="Altavista">Altavista</option>
                        <option value="√Åvalos">√Åvalos</option>
                        <option value="Barrio San Pedro">Barrio San Pedro</option>
                        <option value="Bellavista">Bellavista</option>
                        <option value="Cafetales">Cafetales</option>
                        <option value="Campanario">Campanario</option>
                        <option value="Campesina">Campesina</option>
                        <option value="Campobello">Campobello</option>
                        <option value="Centro">Centro</option>
                        <option value="Cerradas de Cumbres">Cerradas de Cumbres</option>
                        <option value="Chihuahua 2000">Chihuahua 2000</option>
                        <option value="Club Campestre">Club Campestre</option>
                        <option value="Colinas del Sol">Colinas del Sol</option>
                        <option value="Cumbres">Cumbres</option>
                        <option value="Cumbres del Sur">Cumbres del Sur</option>
                        <option value="Dale">Dale</option>
                        <option value="Delicias">Delicias</option>
                        <option value="Diego Lucero">Diego Lucero</option>
                        <option value="El Palomar">El Palomar</option>
                        <option value="Francisco I. Madero">Francisco I. Madero</option>
                        <option value="Granjas">Granjas</option>
                        <option value="Guadalupe">Guadalupe</option>
                        <option value="Independencia">Independencia</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Jardines del Santuario">Jardines del Santuario</option>
                        <option value="Josefa Ortiz de Dominguez">Josefa Ortiz de Dominguez</option>
                        <option value="Kennedy">Kennedy</option>
                        <option value="La Cantera">La Cantera</option>
                        <option value="Las Granjas">Las Granjas</option>
                        <option value="Lomas">Lomas</option>
                        <option value="Lomas del Santuario">Lomas del Santuario</option>
                        <option value="Los Nogales">Los Nogales</option>
                        <option value="M√°rmol">M√°rmol</option>
                        <option value="Mart√≠n L√≥pez">Mart√≠n L√≥pez</option>
                        <option value="Mirador">Mirador</option>
                        <option value="Nombre de Dios">Nombre de Dios</option>
                        <option value="Obrera">Obrera</option>
                        <option value="Pac√≠fico">Pac√≠fico</option>
                        <option value="Palmas">Palmas</option>
                        <option value="Panamericana">Panamericana</option>
                        <option value="Parques de San Felipe">Parques de San Felipe</option>
                        <option value="Paseos de Chihuahua">Paseos de Chihuahua</option>
                        <option value="Pinos">Pinos</option>
                        <option value="Ponce de Le√≥n">Ponce de Le√≥n</option>
                        <option value="Quintas Carolinas">Quintas Carolinas</option>
                        <option value="Quintas del Sol">Quintas del Sol</option>
                        <option value="Revoluci√≥n">Revoluci√≥n</option>
                        <option value="Riberas de Sacramento">Riberas de Sacramento</option>
                        <option value="Rosario">Rosario</option>
                        <option value="Sacramento">Sacramento</option>
                        <option value="San Felipe Viejo">San Felipe Viejo</option>
                        <option value="San Francisco">San Francisco</option>
                        <option value="San Jos√©">San Jos√©</option>
                        <option value="San Miguel">San Miguel</option>
                        <option value="San Rafael">San Rafael</option>
                        <option value="Santa Rita">Santa Rita</option>
                        <option value="Santa Rosa">Santa Rosa</option>
                        <option value="Santo Ni√±o">Santo Ni√±o</option>
                        <option value="Saucito">Saucito</option>
                        <option value="Sector Bol√≠var">Sector Bol√≠var</option>
                        <option value="Tecnol√≥gico">Tecnol√≥gico</option>
                        <option value="Tierra y Libertad">Tierra y Libertad</option>
                        <option value="Unidad Chihuahua">Unidad Chihuahua</option>
                        <option value="Valle de la Madrid">Valle de la Madrid</option>
                        <option value="Valle del Sol">Valle del Sol</option>
                        <option value="Villa">Villa</option>
                        <option value="Vistas del Norte">Vistas del Norte</option>
                        <option value="Zootecnia">Zootecnia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="delivery-numero">N√∫mero Exterior</label>
                    <input type="text" id="delivery-numero" required
                           minlength="1" maxlength="10"
                           pattern="[0-9A-Za-z\-]+"
                           title="N√∫mero v√°lido (puede incluir letras, ej: 123-A)"
                           placeholder="Ej: 456">
                </div>
                <button type="submit" class="btn-enviar">Confirmar Pedido</button>
            </form>
        </div>
    </div>

    <!-- Estructura del Modal de Alerta Gen√©rico (Oculto por defecto) -->
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <h2 id="alert-modal-title">Aviso</h2>
            <p id="alert-modal-message" class="subtitulo-catalogo" style="margin-bottom: 1.5rem;"></p>
            <button id="alert-modal-close" class="btn-cita">Aceptar</button>
        </div>
    </div>

</body>
</html>


